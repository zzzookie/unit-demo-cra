name: Release

on:
  push:
    tags:
      - v*

jobs:
  create_release:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    permissions:
      contents: write

    steps:
    
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Install dependencies
        run: npm install --force

      - name: Set up environment variables
        run: |
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          echo "LAST_TAG=$(git describe --tags --abbrev=0 ${TAG_NAME}^)" >> $GITHUB_ENV
          echo "USER_NAME=$(git --no-pager show -s --format='%aN')" >> $GITHUB_ENV
          echo "USER_EMAIL=$(git --no-pager show -s --format='%aE')" >> $GITHUB_ENV
      
      - name: Generate Changelog
        id: changelog_gen
        uses: metcalfc/changelog-generator@v4.0.0
        with:
          myToken: ${{ github.token }}

      - name: Write Changelog File
        uses: DamianReeves/write-file-action@v1.2
        with:
          path: changelog.md
          write-mode: append
          contents: |
            ## Release ${TAG_NAME}
            Changes:
            ${{ steps.changelog_gen.outputs.changelog }}
            
      - name: Commit & Push
        uses: Andro999b/push@v1.3
        with:
          github_token: ${{ github.token }}
          branch: tests
          force: true
          message: 'Changelog updated - {LAST_TAG} $LAST_TAG ${{ LAST_TAG }} $(LAST_TAG) added'

      - name: Create release
        run: |
          git config --local user.email "$USER_EMAIL"
          git config --local user.name "$USER_NAME"
          changelog=$(git log $(git describe --tags --abbrev=0)..HEAD --oneline)
          release_version=${TAG_NAME}
          release_date=$(date -u +"%d-%m-%Y")
          release_title="Release ${TAG_NAME}"
          release_body="**Author**: @${{ github.actor }}
          **Date**: ${release_date}
          **Version**: ${TAG_NAME}

          **Changelog**:
          ${CHANGELOG}"
          gh release create ${TAG_NAME} -t "${release_title}" -n "${release_body}"
